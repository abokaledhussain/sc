<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“˜ ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰ (Pro)</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{--primary:#1f5fa6;--primary-700:#174b83;--accent:#0ea5e9;--bg:#f2f4f8;--card:#fff;--muted:#6b7280;--ok:#16a34a;--warn:#ef4444;--border:#e5e7eb;--delay:#f59e0b}
*{box-sizing:border-box} html,body{overflow-x:hidden}
body{margin:0;background:var(--bg);font-family:Cairo,sans-serif;color:#111}
.container{max-width:1100px;margin:24px auto;padding:0 16px}
header{position:relative;background:linear-gradient(135deg,var(--primary),var(--primary-700));color:#fff;border-radius:16px;padding:16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
header h1{margin:0;font-size:22px;line-height:1.4}
header p{margin:6px 0 0;color:#e2e8f0;font-size:13px;line-height:1.6}
#schoolLogo{max-height:64px;max-width:120px;object-fit:contain}
.logo-wrap{display:flex;align-items:center;gap:8px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:12px}
.toolbar,.filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.btn{border:1px solid var(--border);border-radius:10px;background:#fff;padding:8px 12px;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
input,select,textarea{width:100%;padding:9px;border:1px solid var(--border);border-radius:10px}
textarea{min-height:110px}
.small{color:var(--muted);font-size:12px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-fit{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px}
.table-card{overflow:auto;border-radius:14px}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{background:#eff6ff;padding:10px;border-bottom:1px solid var(--border);text-align:right;position:sticky;top:0}
tbody td{padding:10px;border-bottom:1px solid var(--border)}
.mono{font-family:ui-monospace,monospace}
.nowrap{white-space:nowrap}
.hidden{display:none}
.tag{border-radius:999px;padding:2px 8px;font-size:12px}
.row-meta{display:flex;flex-direction:column;gap:4px}
.meta-line{font-size:12px;color:#334155}
.badge-warn{display:inline-flex;align-items:center;gap:6px;background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;border-radius:999px;padding:2px 8px;font-size:12px}

/* Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ†) */
/* ** ØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ overflow-y:auto Ù‡Ù†Ø§ ** */
.settings-panel{position:fixed;top:0;right:-420px;width:420px;height:100vh;background:#fff;box-shadow:-3px 0 14px rgba(0,0,0,.12);border-left:1px solid var(--border);transition:.3s;z-index:1000;padding:20px;display:flex;flex-direction:column;gap:10px;overflow-y:auto}
.settings-panel.open{right:0}
.settings-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.close-settings{cursor:pointer;background:none;border:none;font-size:20px;color:#666}
.accordion{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
.acc-head{padding:12px 14px;background:#f8fafc;cursor:pointer;font-weight:700;display:flex;align-items:center;gap:8px}
.acc-body{padding:12px 14px;display:none}
.accordion.open .acc-body{display:block}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;justify-content:center;align-items:center;z-index:2000} /* Ø±ÙØ¹ Ø§Ù„Ù€ z-index */
.modal-content{background:#fff;width:min(980px,94vw);max-height:86vh;overflow:auto;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
.close{float:left;cursor:pointer;font-size:26px;color:#555}
.stats-table{width:100%;border-collapse:collapse;margin-top:8px}
.stats-table th,.stats-table td{border:1px solid #e5e7eb;padding:8px;text-align:center}
.stats-table th{background:#f1f5f9}
/* Ù…Ø¹Ø§ÙŠÙ†Ø§Øª */
.logo-preview{display:flex;align-items:center;gap:10px}
.logo-preview img{max-height:56px;max-width:140px;border:1px dashed var(--border);padding:6px;border-radius:8px;background:#fafafa}

/* ØªØ±ÙˆÙŠØ³Ø© Ø³Ø§Ø¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
.header-plain{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.header-plain .col{line-height:1.5;font-weight:700}
.header-plain .col.center{display:flex;align-items:center;justify-content:center}
.header-date{margin:6px 0 10px;text-align:center;font-size:13px;color:#111}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>ğŸ“˜ ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰</h1>
      <p>Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„: ÙƒØ´ÙˆÙØ§Øª â€“ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨ â€“ Ø¥Ø­ØµØ§Ø¡Ø§Øª. ØªØ·ÙˆÙŠØ± ÙˆØ¯Ø¹Ù… / Ø­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±ÙŠØ§Ù†ÙŠ</p>
    </div>
    <div class="logo-wrap">
      <img id="schoolLogo" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" class="hidden">
      <button class="btn" onclick="openSettings()">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </header>

  <div class="card">
    <div class="toolbar">
      <label class="btn" style="background:var(--primary);color:#fff;border-color:transparent">
        ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel
        <input id="excelInput" type="file" accept=".xlsx,.xls" hidden>
      </label>

      <label class="btn">
        â­³ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© (JSON)
        <input id="restoreInput" type="file" accept=".json" hidden>
      </label>

      <button class="btn" id="exportBtn">ğŸ’¾ ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
      <button class="btn" id="clearBtn">ğŸ§¹ ØªÙØ±ÙŠØº Ø§Ù„ØªØ®Ø²ÙŠÙ†</button>

      <div style="flex:1;min-width:240px"><input id="searchBox" type="text" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©..."></div>

      <button class="btn" id="printBtn" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØµÙÙ‘Ø§Ø©">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn" id="exportExcelBtn" title="ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØµÙÙ‘Ø§Ø© Ø¥Ù„Ù‰ Excel">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
      <button class="btn" id="exportAllPdfBtn" title="Ø§Ø³ØªØ®Ø±Ø§Ø¬ PDF Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨">ğŸ“„ PDF Ø§Ù„ÙƒÙ„</button>
    </div>

    <div class="filters">
      <div>
        <label class="small">Ø§Ù„ØµÙ</label>
        <select id="gradeFilter"><option value="">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option></select>
      </div>
      <div>
        <label class="small">Ø§Ù„ÙØµÙ„</label>
        <select id="classFilter" disabled><option value="">ÙƒÙ„ Ø§Ù„ÙØµÙˆÙ„</option></select>
      </div>
      <button class="btn" id="resetFiltersBtn">â™»ï¸ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      <span class="small">ØªÙ†Ø³ÙŠÙ‚ Excel: Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ØŒ Ø§Ù„Ø¬ÙˆØ§Ù„ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©ØŒ Ø§Ù„ØµÙØŒ Ø§Ù„ÙØµÙ„</span>

      <button class="btn" id="toggleAddFormBtn" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
  </div>

  <div class="card" id="addFormCard">
    <h3 id="formTitle" style="margin-top:0">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    <div class="grid-2">
      <div><label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label><input id="f_name" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ"></div>
      <div><label>Ø§Ù„Ø¬ÙˆØ§Ù„</label><input id="f_phone" type="tel" placeholder="05xxxxxxxx"><div class="small">ÙŠÙØ­ÙˆÙ‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„ØµÙŠØºØ© ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© (+966)</div></div>
      <div><label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input id="f_id" type="text" placeholder="10 Ø£Ø±Ù‚Ø§Ù…"></div>
      <div class="grid-fit">
        <div><label>Ø§Ù„ØµÙ</label><input id="f_grade" type="text" placeholder="Ø£ÙˆÙ„ / Ø«Ø§Ù†ÙŠ / Ø«Ø§Ù„Ø«..."></div>
        <div><label>Ø§Ù„ÙØµÙ„</label><input id="f_class" type="text" placeholder="Ø£ / Ø¨ / 1 / 2"></div>
      </div>
    </div>
    <div class="toolbar" style="gap:10px;margin-top:12px">
      <button class="btn" style="background:var(--ok);color:#fff;border-color:transparent" id="saveBtn">Ø­ÙØ¸</button>
      <button class="btn hidden" id="cancelEditBtn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
  </div>

  <div class="card" id="waSection">
    <h3 style="margin-top:0">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© ÙˆØ§ØªØ³Ø§Ø¨</h3>
    <div class="grid-2">
      <div>
        <label>ğŸ“© Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
        <select id="templateSelect">
          <option value="delay">1) ØªØ£Ø®Ø± Ø§Ø¨Ù†ÙƒÙ… Ø§Ù„ÙŠÙˆÙ…</option>
          <option value="absent">2) ØºÙŠØ§Ø¨ Ø§Ø¨Ù†ÙƒÙ… Ø§Ù„ÙŠÙˆÙ…</option>
          <option value="custom">3) Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ©</option>
        </select>
        <div class="small">Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: {name}ØŒ {day}ØŒ {date}ØŒ {hijri}ØŒ {fullDate}ØŒ {time}</div>
      </div>

      <div style="display:flex;align-items:flex-end">
        <label class="btn" style="display:inline-flex;align-items:center;gap:8px">âœ… ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø¸Ø§Ù‡Ø±
          <input type="checkbox" id="selectAllFiltered" hidden>
        </label>
      </div>

      <div>
        <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
        <textarea id="bulkMsg" placeholder="Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡"></textarea>
      </div>

      <div>
        <label>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
        <div class="grid-fit">
          <button class="btn" style="background:var(--primary);color:#fff;border-color:transparent" id="bulkWhatsAppBtn">âœ¨ Ø¥Ø¹Ø¯Ø§Ø¯ Ø±ÙˆØ§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨</button>
          <button class="btn" style="background:var(--ok);color:#fff;border-color:transparent" id="startAutoBtn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
          <button class="btn" style="background:var(--warn);color:#fff;border-color:transparent" id="stopAutoBtn" disabled>â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
          <button class="btn" style="background:var(--warn);color:#fff;border-color:transparent" id="bulkDeleteBtn">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†</button>
        </div>
        <div id="autoStatus" class="small" style="display:none;margin-top:6px">Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ØºÙŠØ± Ù†Ø´Ø·</div>
        <div class="small">Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©. ÙŠÙÙØ¶Ù‘Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙŠØ¨).</div>
      </div>
    </div>
    <div style="height:1px;background:var(--border);margin:10px 0"></div>
    <div id="bulkLinks" class="grid-fit hidden"></div>
  </div>

  <div class="card" style="padding:0">
    <div class="table-card">
      <table id="studentsTable">
        <thead>
          <tr>
            <th class="nowrap">ØªØ­Ø¯ÙŠØ¯</th>
            <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„ÙØµÙ„</th>
            <th class="nowrap">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <span class="tag" style="background:#eef2ff;color:#1e3a8a">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="countTotal">0</b></span>
      <span class="tag" style="background:#eef2ff;color:#1e3a8a">Ù…Ø­Ø¯Ø¯: <b id="countSelected">0</b></span>
      <span class="tag" style="background:#eef2ff;color:#1e3a8a">Ù…Ø·Ø§Ø¨Ù‚Ø©: <b id="countFiltered">0</b></span>
    </div>
  </div>
</div>

<div id="settingsPanel" class="settings-panel">
  <div class="settings-header">
    <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
    <button class="close-settings" onclick="closeSettings()">âœ–</button>
  </div>

  <div class="accordion" id="acc-logo">
    <div class="acc-head" onclick="toggleAcc('acc-logo')">ğŸ–¼ï¸ Ø§Ù„Ø´Ø¹Ø§Ø±</div>
    <div class="acc-body">
      <div class="logo-preview">
        <img id="logoPreview" class="hidden" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±">
        <span id="logoNone" class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø¹Ø§Ø± Ø­Ø§Ù„ÙŠÙ‹Ø§</span>
      </div>
      <div class="grid-fit" style="margin-top:8px">
        <label class="btn">â¬†ï¸ Ø§Ø®ØªØ± Ø´Ø¹Ø§Ø±
          <input id="logoInput" type="file" accept="image/*" hidden>
        </label>
        <button class="btn" id="logoRemoveBtn">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±</button>
      </div>
      <div class="small">Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„ØªØµØ¯ÙŠØ±.</div>
    </div>
  </div>

  <div class="accordion open" id="acc-header">
    <div class="acc-head" onclick="toggleAcc('acc-header')">ğŸ“„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©</div>
    <div class="acc-body">
      <div class="grid-2">
        <div><label>Ø§Ù„Ø¯ÙˆÙ„Ø©</label><input id="hdr_country" type="text" value="Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©"></div>
        <div><label>Ø§Ù„ÙˆØ²Ø§Ø±Ø©</label><input id="hdr_ministry" type="text" value="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…"></div>
      </div>
      <div class="grid-2">
        <div><label>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</label><input id="hdr_directorate" type="text" value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø¬Ø¯Ø©"></div>
        <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="hdr_school" type="text" value="Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ù†ÙŠÙ†"></div>
      </div>
      <div class="grid-fit" style="margin-top:6px">
        <button class="btn" id="saveHeaderBtn" style="background:var(--ok);color:#fff">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©</button>
        <button class="btn" id="resetHeaderBtn">ğŸ” Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
      </div>
      <div class="small">Ø³ØªÙØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆExcel ÙˆPDFØŒ ÙˆÙŠÙØ¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ + Ù…ÙŠÙ„Ø§Ø¯ÙŠ) ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ØªØ­Øª Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©.</div>
    </div>
  </div>

  <div class="accordion" id="acc-start">
    <div class="acc-head" onclick="toggleAcc('acc-start')">â° Ø¯ÙˆØ§Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
    <div class="acc-body">
      <label>ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… (24h)</label>
      <div class="grid-fit">
        <input id="schoolStart" type="time" value="07:15">
        <button class="btn" id="saveStartBtn">ğŸ’¾ Ø­ÙØ¸</button>
      </div>
      <div class="small">ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ø­Ø³Ø§Ø¨ Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ£Ø®Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    </div>
  </div>

  <div class="accordion" id="acc-ui">
    <div class="acc-head" onclick="toggleAcc('acc-ui')">ğŸ§© Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</div>
    <div class="acc-body">
      <label class="small">Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡</label>
      <label><input type="checkbox" id="opt_collapseAddForm" checked> Ø¥Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ â•</label><br>
      <label><input type="checkbox" id="opt_hideWASection"> Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨</label><br>
      <label><input type="checkbox" id="opt_showRowSummary" checked> Ù…Ù„Ø®Øµ Ø§Ù„ØºÙŠØ§Ø¨/Ø§Ù„ØªØ£Ø®Ø± ØªØ­Øª Ø§Ù„Ø§Ø³Ù…</label><br>
      <label><input type="checkbox" id="opt_showLastMsg" checked> Ø¥Ø¸Ù‡Ø§Ø± Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©</label><br>
      <label><input type="checkbox" id="opt_showWarnings" checked> Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø¯</label><br>
      <label><input type="checkbox" id="opt_showRowWA" checked> Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ ÙÙŠ ÙƒÙ„ ØµÙ</label><br>
      <button class="btn" id="saveProBtn" style="margin-top:6px">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="accordion" id="acc-thr">
    <div class="acc-head" onclick="toggleAcc('acc-thr')">ğŸš¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±</div>
    <div class="acc-body">
      <div class="grid-2">
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„ØªØ£Ø®Ø± Ù„Ø¸Ù‡ÙˆØ± "Ø¥Ù†Ø°Ø§Ø±"</label><input id="thr_delay_alert" type="number" min="1" value="3"></div>
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„ØªØ£Ø®Ø± Ù„Ø¸Ù‡ÙˆØ± "ØªØ­Ø°ÙŠØ± ÙƒØ¨ÙŠØ±"</label><input id="thr_delay_warn" type="number" min="1" value="5"></div>
      </div>
      <div class="grid-2">
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ø¸Ù‡ÙˆØ± "Ø¥Ù†Ø°Ø§Ø±"</label><input id="thr_absent_alert" type="number" min="1" value="3"></div>
        <div><label>Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ø¸Ù‡ÙˆØ± "ØªØ­Ø°ÙŠØ± ÙƒØ¨ÙŠØ±"</label><input id="thr_absent_warn" type="number" min="1" value="5"></div>
      </div>
      <button class="btn" id="saveThrBtn" style="margin-top:6px">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="accordion" id="acc-wa">
    <div class="acc-head" onclick="toggleAcc('acc-wa')">ğŸ’¬ Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨</div>
    <div class="acc-body">
      <label>Ù‚Ø§Ù„Ø¨ ØªØ£Ø®Ø± Ø§Ù„Ø·Ø§Ù„Ø¨</label><textarea id="tplDelay"></textarea>
      <label>Ù‚Ø§Ù„Ø¨ ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨</label><textarea id="tplAbsent"></textarea>
      <label>Ù‚Ø§Ù„Ø¨ Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ©</label><textarea id="tplCustom"></textarea>
      <div class="grid-fit" style="margin-top:6px">
        <button class="btn" id="saveTplBtn" style="background:var(--primary);color:#fff">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</button>
        <button class="btn" id="resetTplBtn">ğŸ” Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
      </div>
    </div>
  </div>
  
  <div class="accordion" id="acc-pe">
    <div class="acc-head" onclick="toggleAcc('acc-pe')">ğŸ–¨ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„ØªØµØ¯ÙŠØ±</div>
    <div class="acc-body">
      <label>Ø­Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§/ØªØµØ¯ÙŠØ±Ù‡Ø§ Ø¥Ù„Ù‰ Excel</label><br>
      <label><input type="checkbox" id="col_name" checked> Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label><br>
      <label><input type="checkbox" id="col_phone" checked> Ø§Ù„Ø¬ÙˆØ§Ù„</label><br>
      <label><input type="checkbox" id="col_id" checked> Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><br>
      <label><input type="checkbox" id="col_grade" checked> Ø§Ù„ØµÙ</label><br>
      <label><input type="checkbox" id="col_class" checked> Ø§Ù„ÙØµÙ„</label><br>
      <div class="grid-fit" style="margin-top:6px">
        <button class="btn" id="savePEBtn" style="background:var(--ok);color:#fff">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
        <button class="btn" id="resetPEBtn">ğŸ” Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
      </div>
      <div class="small">Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙ†Ø·Ø¨Ù‚ Ø¹Ù„Ù‰ **"Ø·Ø¨Ø§Ø¹Ø©"** Ùˆ **"ØªØµØ¯ÙŠØ± Excel"**.</div>
    </div>
  </div>
  
</div>
<div id="settingsOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.15);display:none;z-index:999" onclick="closeSettings()"></div>

<script>
/* ===== Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ===== */
const LS_KEY='students_db_v1', SETTINGS_KEY='students_settings_v1', TPL_KEY='messageTemplates_v1', PE_KEY='printExport_prefs_v1', LOGO_KEY='school_logo_base64_v1';
const REC_KEY = 'attendance_records_v1'; const PRO_KEY = 'pro_options_v1'; const HDR_KEY = 'print_header_v1';

/* ===== Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ===== */
let students=[], editingUid=null, searchText='', gradeFilter='', classFilter='';
let selectedUids=new Set(); let autoTimer=null, autoQueue=[], autoIndex=0;
let settings={hijriAdjust:0, schoolStart:'07:15'};
let templates=null; let pePrefs=null; let schoolLogo=null;
let pro={showRowSummary:true,showLastMsg:true,showWarnings:true,showRowWA:true,collapseAddForm:true,hideWASection:false,thr:{delay_alert:3,delay_warn:5,absent_alert:3,absent_warn:5}};
let headerData={country:'Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©',ministry:'ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…',directorate:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø¬Ø¯Ø©',school:'Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ù†ÙŠÙ†'};

/* ===== Ø£Ø¯ÙˆØ§Øª ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const uid=()=> 'S'+Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const escapeHtml=t=>String(t??'').replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
const localeSort=(a,b)=>a.localeCompare(b,'ar',{numeric:true,sensitivity:'base'});

/* ===== ÙˆØ§ØªØ³Ø§Ø¨ ===== */
function toSaudiWhatsApp(numRaw){if(!numRaw)return'';let n=String(numRaw).replace(/\D+/g,'');if(n.startsWith('00966'))n=n.replace(/^00966/,'');if(n.startsWith('966'))n=n.replace(/^966/,'');if(n.startsWith('0'))n=n.slice(1);return '+966'+n}
function waLink(phone,text){const p=toSaudiWhatsApp(phone).replace(/^\+/,'');return `https://wa.me/${p}?text=${encodeURIComponent(text||'')}`}

/* ===== Ø§Ù„ÙŠÙˆÙ… + Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ/Ù…ÙŠÙ„Ø§Ø¯ÙŠ) ===== */
function todayInfo(dateObj){
  const d = dateObj? new Date(dateObj): new Date();
  const days = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
  const day = days[d.getDay()];
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  const miladi = `${dd} / ${mm} / ${yyyy}`;
  let hours = d.getHours();
  const minutes = String(d.getMinutes()).padStart(2,'0');
  const isPM = hours >= 12; const period = isPM ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ù‹Ø§';
  if(hours == 0) hours = 12; if(hours > 12) hours -= 12;
  const time = `${hours}:${minutes} ${period}`;
  let hijri='';
  try{
    const parts = new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'2-digit',month:'2-digit',year:'numeric'}).formatToParts(new Date(d.getTime()+ (Number(settings.hijriAdjust||0))*86400000));
    const hDay = parts.find(p=>p.type==='day')?.value || '';
    const hMon = parts.find(p=>p.type==='month')?.value || '';
    const hYear = parts.find(p=>p.type==='year')?.value || '';
    hijri = `${hDay} / ${hMon} / ${hYear}Ù‡Ù€`;
  }catch{hijri='(Ø§Ù„Ù‡Ø¬Ø±ÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…)'};
  return {day,miladi,hijri,time,fullDate:`${miladi} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${hijri}`};
}

/* ===== Ù‚ÙˆØ§Ù„Ø¨ ===== */
function defaultTemplates(){return{
  delay:`Ù†ÙˆØ¯ Ø¥Ø¨Ù„Ø§ØºÙƒÙ… Ø¨Ø£Ù† Ø§Ø¨Ù†ÙƒÙ… {name} ØªØ£Ø®Ø± Ø¹Ù† Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ… {day} {fullDate}.`,
  absent:`Ù†ÙˆØ¯ Ø¥Ø¨Ù„Ø§ØºÙƒÙ… Ø¨Ø£Ù† Ø§Ø¨Ù†ÙƒÙ… {name} ØºØ§Ø¨ Ø¹Ù† Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ… {day} {fullDate}.`,
  custom:`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ {name}ØŒ Ø§Ù„ÙŠÙˆÙ…: {day}ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®: {date} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ {hijri}.`
}}
function loadTemplates(){try{templates=JSON.parse(localStorage.getItem(TPL_KEY)||'null')||defaultTemplates()}catch{templates=defaultTemplates()}
  $('#tplDelay').value=templates.delay;$('#tplAbsent').value=templates.absent;$('#tplCustom').value=templates.custom;}
function saveTemplates(){templates={delay:$('#tplDelay').value||defaultTemplates().delay,absent:$('#tplAbsent').value||defaultTemplates().absent,custom:$('#tplCustom').value||defaultTemplates().custom};localStorage.setItem(TPL_KEY,JSON.stringify(templates));applyTemplateToBox();alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨.')}
function resetTemplates(){templates=defaultTemplates();localStorage.setItem(TPL_KEY,JSON.stringify(templates));loadTemplates();applyTemplateToBox();alert('ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.')}

/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„ØªØµØ¯ÙŠØ± ===== */
function defaultPE(){return{columns:{name:true,phone:true,id:true,grade:true,class:true}}}
function loadPE(){try{pePrefs=JSON.parse(localStorage.getItem(PE_KEY)||'null')||defaultPE()}catch{pePrefs=defaultPE()}
  $('#col_name').checked=!!pePrefs.columns.name;$('#col_phone').checked=!!pePrefs.columns.phone;$('#col_id').checked=!!pePrefs.columns.id;$('#col_grade').checked=!!pePrefs.columns.grade;$('#col_class').checked=!!pePrefs.columns.class;}
function savePE(){pePrefs={columns:{name:$('#col_name').checked,phone:$('#col_phone').checked,id:$('#col_id').checked,grade:$('#col_grade').checked,class:$('#col_class').checked}};localStorage.setItem(PE_KEY,JSON.stringify(pePrefs));alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„ØªØµØ¯ÙŠØ±.')}
function resetPE(){pePrefs=defaultPE();localStorage.setItem(PE_KEY,JSON.stringify(pePrefs));loadPE();alert('ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.')}
function getSelectedColumns(){ const order=['name','phone','id','grade','class']; const labels={name:'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨',phone:'Ø§Ù„Ø¬ÙˆØ§Ù„',id:'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©',grade:'Ø§Ù„ØµÙ',class:'Ø§Ù„ÙØµÙ„'}; const cols=pePrefs?.columns||defaultPE().columns; return {order:order.filter(k=>!!cols[k]), labels}; }

/* ===== Ø§Ù„Ø´Ø¹Ø§Ø± ===== */
function loadLogo(){try{schoolLogo=localStorage.getItem(LOGO_KEY)||null}catch{schoolLogo=null}
  const headerImg=$('#schoolLogo'), prevImg=$('#logoPreview'), none=$('#logoNone');
  if(schoolLogo){headerImg.src=schoolLogo;headerImg.classList.remove('hidden');prevImg.src=schoolLogo;prevImg.classList.remove('hidden');none.classList.add('hidden')}
  else{headerImg.classList.add('hidden');prevImg.classList.add('hidden');none.classList.remove('hidden')}
}
function handleLogoFile(file){if(!file)return;const reader=new FileReader();reader.onload=()=>{try{localStorage.setItem(LOGO_KEY,reader.result);loadLogo();alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø±.')}catch(e){alert('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± (Ø­Ø¬Ù… ÙƒØ¨ÙŠØ±).')}};reader.readAsDataURL(file)}
document.getElementById('logoInput')?.addEventListener('change',e=>{handleLogoFile(e.target.files?.[0]);e.target.value=''})
document.getElementById('logoRemoveBtn')?.addEventListener('click',()=>{if(confirm('Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±ØŸ')){localStorage.removeItem(LOGO_KEY);schoolLogo=null;loadLogo();}})

/* ===== Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ===== */
function getStartMinutes(){const t=(settings.schoolStart||'07:15').trim();const m=/^(\d{1,2}):(\d{2})$/.exec(t);if(!m)return 7*60+15;return Math.min(23,Math.max(0,parseInt(m[1],10)))*60+Math.min(59,Math.max(0,parseInt(m[2],10)))}
function computeDelayMinutes(d=new Date()){const minsNow=d.getHours()*60+d.getMinutes();const start=getStartMinutes();return Math.max(0,minsNow-start)}
function loadRecords(){try{return JSON.parse(localStorage.getItem(REC_KEY)||'{}')}catch{return{}}}
function saveRecords(rec){localStorage.setItem(REC_KEY,JSON.stringify(rec))}
function addRecord(uid,type,extra={}){
  if(!uid)return;const recs=loadRecords();if(!recs[uid])recs[uid]=[];
  const now=todayInfo();
  // id: to uniquely identify the record, using a combination of timestamp and random string
  const rec={id:Date.now().toString(36)+Math.random().toString(36).slice(2,7),type,minutes:type==='delay'?computeDelayMinutes():null,date:now.miladi,hijri:now.hijri,time:String(new Date().getHours()).padStart(2,'0')+':'+String(new Date().getMinutes()).padStart(2,'0'),ts:Date.now(),...extra};
  recs[uid].push(rec);saveRecords(recs);
  if(currentStatsUid && currentStatsUid===uid){try{showStats(uid)}catch{}}
}
function summarize(uid){const recs=loadRecords()[uid]||[];let absent=0,delayMin=0,last=null;recs.forEach(r=>{if(r.type==='absent')absent++;if(r.type==='delay')delayMin+=(r.minutes||0);if(!last||(r.ts||0)>(last.ts||0))last=r});const delayCount=recs.filter(r=>r.type==='delay').length;return{absent,delayMin,delayCount,last}}

/* ===== ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù„Ø§Ø¨ ===== */
function saveLS(){localStorage.setItem(LS_KEY,JSON.stringify(students));refreshFiltersOptions();render()}
function loadLS(){try{const v=JSON.parse(localStorage.getItem(LS_KEY)||'[]');students=Array.isArray(v)?v:[]}catch{students=[]}}

/* ===== ÙÙ„Ø§ØªØ± ===== */
function refreshFiltersOptions(){const gradeSel=$('#gradeFilter');if(!gradeSel)return;const grades=[...new Set(students.map(s=>(s.grade||'').trim()).filter(Boolean))].sort(localeSort);const prev=gradeFilter;gradeSel.innerHTML=`<option value="">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>`+grades.map(g=>`<option ${g===prev?'selected':''} value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join('');applyClassOptions();gradeFilter=$('#gradeFilter').value||'';classFilter=$('#classFilter').value||''}
function applyClassOptions(){const classSel=$('#classFilter');if(!classSel)return;const g=$('#gradeFilter')?.value||'';let classes=[];if(g){classes=[...new Set(students.filter(s=>(s.grade||'').trim()===g).map(s=>(s.class||'').trim()).filter(Boolean))].sort(localeSort)}else{classes=[...new Set(students.map(s=>(s.class||'').trim()).filter(Boolean))].sort(localeSort)}const keep=classFilter;classSel.disabled=false;classSel.innerHTML=`<option value="">ÙƒÙ„ Ø§Ù„ÙØµÙˆÙ„</option>`+classes.map(c=>`<option ${c===keep?'selected':''} value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
function filterFn(s){const q=(searchText||'').trim().toLowerCase();const mt=!q||((s.name||'').toLowerCase().includes(q)||String(s.id||'').toLowerCase().includes(q));const mg=!gradeFilter||(String(s.grade||'').trim()===gradeFilter);const mc=!classFilter||(String(s.class||'').trim()===classFilter);return mt&&mg&&mc}
function getFiltered(){return students.filter(filterFn)}

/* ===== ØªØ­Ø¯ÙŠØ¯ ===== */
function updateSelectedCount(){const el=$('#countSelected');if(el)el.textContent=selectedUids.size}
function clearSelectionsAndLinks(){selectedUids.clear();$$('.rowSel').forEach(cb=>cb.checked=false);$('#selectAllFiltered').checked=false;const box=$('#bulkLinks');box.innerHTML='';box.classList.add('hidden');updateSelectedCount()}
function getSelected(){return students.filter(s=>selectedUids.has(s.uid))}

/* ===== Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
function render(){const tbody=$('#tbody');if(!tbody)return;tbody.innerHTML='';const filtered=getFiltered();filtered.forEach(s=>{const tr=document.createElement('tr');const checked=selectedUids.has(s.uid)?'checked':'';const sum=summarize(s.uid);
  let nameHtml=`<div class="row-meta"><b>${escapeHtml(s.name||'')}</b>`;
  if(pro.showRowSummary) nameHtml+=`<div class="meta-line">ğŸ“Š ${sum.absent} ØºÙŠØ§Ø¨ â€“ ${sum.delayMin} Ø¯Ù‚ÙŠÙ‚Ø© ØªØ£Ø®Ø±</div>`;
  if(pro.showLastMsg && sum.last) nameHtml+=`<div class="meta-line">ğŸ“¬ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©: ${sum.last.date} - ${sum.last.time}</div>`;
  if(pro.showWarnings && sum.delayCount>=pro.thr.delay_alert) nameHtml+=`<div class="meta-line"><span class="badge-warn">Ø¥Ù†Ø°Ø§Ø± ØªØ£Ø®Ø± (${sum.delayCount})</span></div>`;
  nameHtml+=`</div>`;
  const waUrl=waLink(s.phone,`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆÙ„ÙŠ Ø£Ù…Ø± ${s.name??''}`);
  const waBtn=pro.showRowWA?`<a class="btn row-wa" data-uid="${s.uid}" href="${waUrl}" target="_blank" style="padding:6px 9px;background:var(--accent);color:#003049;border-color:transparent">ğŸŸ¢ ÙˆØ§ØªØ³Ø§Ø¨</a>`:'';
  tr.innerHTML=`
<td><input type="checkbox" class="rowSel" data-uid="${s.uid}" ${checked}></td>
<td>${nameHtml}</td>
<td class="mono">${escapeHtml(s.phone||'')}</td>
<td class="mono">${escapeHtml(s.id||'')}</td>
<td>${escapeHtml(s.grade||'')}</td>
<td>${escapeHtml(s.class||'')}</td>
<td>
  <div style="display:flex;gap:6px;flex-wrap:wrap">
    <a class="btn" style="padding:6px 9px" href="tel:${encodeURIComponent(s.phone||'')}" title="Ø§ØªØµØ§Ù„">ğŸ“</a>
    ${waBtn}
    <button class="btn stats-btn" style="padding:6px 9px" data-act="stats" data-uid="${s.uid}" title="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">ğŸ“Š</button>
    <button class="btn" style="padding:6px 9px" data-act="edit" data-uid="${s.uid}">âœ</button>
    <button class="btn" style="padding:6px 9px;background:var(--warn);color:#fff;border-color:transparent" data-act="del" data-uid="${s.uid}">ğŸ—‘</button>
  </div>
</td>`;
  tbody.appendChild(tr);
});$('#countTotal').textContent=students.length;$('#countFiltered').textContent=filtered.length;updateSelectedCount()
// ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ ÙÙŠ Ø§Ù„ØµÙ
$$('.row-wa').forEach(a=>{a.addEventListener('click',()=>{const uid=a.getAttribute('data-uid');const tSel=$('#templateSelect')?.value||'custom';const type=(tSel==='delay'?'delay':(tSel==='absent'?'absent':'notice'));addRecord(uid,type);});});
}

/* ===== CRUD ===== */
function fillForm(s){$('#f_name').value=s?.name||'';$('#f_phone').value=s?.phone||'';$('#f_id').value=s?.id||'';$('#f_grade').value=s?.grade||'';$('#f_class').value=s?.class||''}
function clearForm(){editingUid=null;fillForm({});$('#formTitle').textContent='â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';$('#cancelEditBtn').classList.add('hidden');$('#saveBtn').textContent='Ø­ÙØ¸'}
function submitForm(){const s={name:$('#f_name').value.trim(),phone:$('#f_phone').value.trim(),id:$('#f_id').value.trim(),grade:$('#f_grade').value.trim(),class:$('#f_class').value.trim()};if(!s.name){alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨');return}if(editingUid){const i=students.findIndex(x=>x.uid===editingUid);if(i>-1)students[i]={...students[i],...s}}else students.unshift({uid:uid(),...s});saveLS();clearForm()}
function deleteByUid(u){const i=students.findIndex(x=>x.uid===u);if(i>-1){students.splice(i,1);saveLS()}}

/* ===== Excel: Ù‚Ø±Ø§Ø¡Ø© ÙˆÙÙ‚ ØªØ±ØªÙŠØ¨Ùƒ (Ø§Ø³Ù…/Ø¬ÙˆØ§Ù„/Ù‡ÙˆÙŠØ©/ØµÙ/ÙØµÙ„) ===== */
function normalizeHeadersRow(row){
  return { 
    name:String(row[0]??'').trim(), 
    phone:String(row[1]??'').trim(), 
    id:String(row[2]??'').trim(), 
    grade:String(row[3]??'').trim(), 
    class:String(row[4]??'').trim() 
  };
}
document.getElementById('excelInput').addEventListener('change', async (e)=>{
  const file=e.target.files?.[0]; e.target.value='';
  if(!file) return;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    const data=new Uint8Array(ev.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
    const out=[]; for(let i=1;i<rows.length;i++){const r=rows[i]; if(!r||r.length===0) continue; const o=normalizeHeadersRow(r); if(!o.name) continue; out.push({uid:uid(),...o});}
    if(!out.length){alert('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ø³Ù… | Ø§Ù„Ø¬ÙˆØ§Ù„ | Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© | Ø§Ù„ØµÙ | Ø§Ù„ÙØµÙ„');return}
    students = out.concat(students); saveLS();
  };
  reader.readAsArrayBuffer(file);
});

/* Ø§Ø³ØªØ¹Ø§Ø¯Ø©/Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ JSON */
document.getElementById('restoreInput').addEventListener('change',(e)=>{
  const f=e.target.files?.[0]; e.target.value='';
  if(!f) return;
  const rd=new FileReader();
  rd.onload=()=>{ try{ const obj=JSON.parse(rd.result||'[]'); if(Array.isArray(obj)){ students=obj; saveLS(); alert('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©.'); } else alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }catch{alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­')} };
  rd.readAsText(f);
});
document.getElementById('exportBtn').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(students,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='students_backup.json'; a.click(); URL.revokeObjectURL(a.href);
});

/* ===== Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© ===== */
document.getElementById('saveBtn').addEventListener('click',submitForm);
document.getElementById('cancelEditBtn').addEventListener('click',clearForm);
document.getElementById('searchBox').addEventListener('input',e=>{searchText=e.target.value||'';render()});
document.getElementById('gradeFilter').addEventListener('change',e=>{gradeFilter=e.target.value||'';applyClassOptions();classFilter=document.getElementById('classFilter').value||'';render()});
document.getElementById('classFilter').addEventListener('change',e=>{classFilter=e.target.value||'';render()});
document.getElementById('resetFiltersBtn').addEventListener('click',()=>{searchText='';gradeFilter='';classFilter='';document.getElementById('searchBox').value='';refreshFiltersOptions();render()});
document.getElementById('clearBtn').addEventListener('click',()=>{if(confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')){students=[];localStorage.removeItem(REC_KEY);saveLS();clearForm();clearSelectionsAndLinks()}});

document.getElementById('toggleAddFormBtn').addEventListener('click',()=>{document.getElementById('addFormCard').classList.toggle('hidden')});
document.getElementById('selectAllFiltered').addEventListener('change',e=>{const state=e.target.checked;const visible=new Set(getFiltered().map(s=>s.uid));if(state)visible.forEach(u=>selectedUids.add(u));else visible.forEach(u=>selectedUids.delete(u));document.querySelectorAll('.rowSel').forEach(cb=>{if(visible.has(cb.dataset.uid))cb.checked=state});updateSelectedCount()});
document.addEventListener('change',e=>{if(e.target.classList.contains('rowSel')){const u=e.target.dataset.uid;e.target.checked?selectedUids.add(u):selectedUids.delete(u);updateSelectedCount()}});
document.addEventListener('click',e=>{
  const b=e.target.closest('button[data-act]'); if(!b) return;
  const act=b.dataset.act, u=b.dataset.uid;
  if(act==='stats'){ showStats(u); }
  else if(act==='edit'){const s=students.find(x=>x.uid===u); if(s){editingUid=u;fillForm(s);$('#formTitle').textContent='âœ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨';$('#cancelEditBtn').classList.remove('hidden');$('#saveBtn').textContent='ØªØ­Ø¯ÙŠØ«'; if($('#addFormCard').classList.contains('hidden')) $('#addFormCard').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'})}}
  else if(act==='del'){ if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) deleteByUid(u); }
});

/* ===== Ø±ÙˆØ§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ ===== */
function applyPlaceholders(text, name){ const t=todayInfo(); return String(text||'').replaceAll('{name}',name||'').replaceAll('{day}',t.day).replaceAll('{date}',t.miladi).replaceAll('{hijri}',t.hijri).replaceAll('{fullDate}',t.fullDate).replaceAll('{time}',t.time) }
function buildTemplate(type,studentName){ const raw = type==='delay'?templates.delay: type==='absent'?templates.absent: ($('#bulkMsg')?.value||templates.custom); return applyPlaceholders(raw, studentName) }
document.getElementById('bulkDeleteBtn').addEventListener('click',()=>{const chosen=getSelected();if(!chosen.length){alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø­Ø¯Ø¯ÙˆÙ†.');return}if(!confirm(`Ø³ÙŠØªÙ… Ø­Ø°Ù ${chosen.length} Ø·Ø§Ù„Ø¨. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`))return;const remove=new Set(chosen.map(s=>s.uid));students=students.filter(s=>!remove.has(s.uid));const recs=loadRecords(); for(const u of remove){ delete recs[u]; } saveRecords(recs); saveLS();clearSelectionsAndLinks()});
document.getElementById('bulkWhatsAppBtn').addEventListener('click',()=>{
  const sel=getSelected(), box=$('#bulkLinks');box.innerHTML='';
  if(!sel.length){alert('Ø§Ø®ØªØ± Ø·Ù„Ø§Ø¨Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§.');return}
  const tSel=$('#templateSelect').value;
  sel.forEach(s=>{
    const msg=buildTemplate(tSel,s.name||'');
    const a=document.createElement('a');
    a.className='btn bulk-wa'; a.style.padding='6px 9px'; a.style.background='var(--accent)'; a.style.color:'#003049';
    a.target='_blank'; a.rel='noopener'; a.href=waLink(s.phone,msg); a.textContent=`ÙˆØ§ØªØ³Ø§Ø¨: ${s.name||s.phone}`;
    a.dataset.uid=s.uid; a.dataset.type=(tSel==='delay'?'delay':(tSel==='absent'?'absent':'notice'));
    box.appendChild(a);
  });
  const done=document.createElement('button');done.className='btn';done.style.marginTop='8px';done.textContent='âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ù…Ø³Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ¯)';done.onclick=()=>clearSelectionsAndLinks();box.appendChild(done);
  box.classList.remove('hidden');box.scrollIntoView({behavior:'smooth',block:'center'});

  // ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ ÙŠØ¯ÙˆÙŠ
  $$('.bulk-wa').forEach(a=>{
    a.addEventListener('click',()=>{
      const u=a.dataset.uid, typ=a.dataset.type; addRecord(u,typ);
    });
  });
});
document.getElementById('startAutoBtn').addEventListener('click',()=>{
  const sel=getSelected();if(!sel.length){alert('Ø§Ø®ØªØ± Ø·Ù„Ø§Ø¨Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§.');return}
  const tSel=$('#templateSelect').value;
  autoQueue=sel.map(s=>({url:waLink(s.phone,buildTemplate(tSel,s.name||'')),name:s.name||s.phone,uid:s.uid,type:(tSel==='delay'?'delay':(tSel==='absent'?'absent':'notice'))}));
  autoIndex=0;startAutoSending()
});
document.getElementById('stopAutoBtn').addEventListener('click',()=>stopAutoSending(true));
function openInNewTabSafe(url){const w=window.open(url,'_blank');if(!w){alert('Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù€ Pop-ups Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');stopAutoSending(true)}}
function startAutoSending(){
  if(!autoQueue.length){alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.');return}
  if(autoTimer){clearInterval(autoTimer);autoTimer=null}
  $('#startAutoBtn').disabled=true;$('#stopAutoBtn').disabled=false;
  const first=autoQueue[autoIndex]; openInNewTabSafe(first.url); addRecord(first.uid, first.type); autoIndex++;
  autoTimer=setInterval(()=>{
    if(autoIndex>=autoQueue.length){stopAutoSending(false);return}
    const item=autoQueue[autoIndex]; openInNewTabSafe(item.url); addRecord(item.uid, item.type); autoIndex++;
  },2000)
}
function stopAutoSending(manual){if(autoTimer){clearInterval(autoTimer);autoTimer=null}$('#startAutoBtn').disabled=false;$('#stopAutoBtn').disabled=true;clearSelectionsAndLinks()}

/* ===== ØªØ±ÙˆÙŠØ³Ø© Ø³Ø§Ø¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/PDF/Excel ===== */
function loadHeaderData(){
  try{ const v=JSON.parse(localStorage.getItem(HDR_KEY)||'null'); if(v&&typeof v==='object'){ headerData={...headerData,...v}; } }catch{}
  $('#hdr_country').value = headerData.country|| '';
  $('#hdr_ministry').value = headerData.ministry|| '';
  $('#hdr_directorate').value = headerData.directorate|| '';
  $('#hdr_school').value = headerData.school|| '';
}
function saveHeaderData(){
  headerData={
    country: $('#hdr_country').value||'',
    ministry: $('#hdr_ministry').value||'',
    directorate: $('#hdr_directorate').value||'',
    school: $('#hdr_school').value||''
  };
  localStorage.setItem(HDR_KEY, JSON.stringify(headerData));
  alert('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©.');
}
function resetHeaderData(){
  headerData={country:'Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©',ministry:'ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…',directorate:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø¬Ø¯Ø©',school:'Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ù†ÙŠÙ†'};
  localStorage.setItem(HDR_KEY, JSON.stringify(headerData)); loadHeaderData(); alert('ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.');
}
$('#saveHeaderBtn')?.addEventListener('click',saveHeaderData);
$('#resetHeaderBtn')?.addEventListener('click',resetHeaderData);

function buildOfficialHeaderHTML(){
  const logoImg=localStorage.getItem(LOGO_KEY)||'';
  const t=todayInfo();
  return `
  <div class="header-plain">
    <div class="col right">
      ${escapeHtml(headerData.country||'')}<br>${escapeHtml(headerData.ministry||'')}
    </div>
    <div class="col center">${logoImg?`<img src="${logoImg}" style="max-height:70px;max-width:160px;object-fit:contain" alt="Ø§Ù„Ø´Ø¹Ø§Ø±">`:''}</div>
    <div class="col left" style="text-align:left">
      ${escapeHtml(headerData.directorate||'')}<br>${escapeHtml(headerData.school||'')}
    </div>
  </div>
  <div class="header-date">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${t.hijri} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${t.miladi}</div>`;
}

/* ===== Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
function printTableOnly(){
  const data=getFiltered(); if(!data.length){alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§');return}
  const t=todayInfo(), grade=gradeFilter||'ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ', cls=classFilter||'ÙƒÙ„ Ø§Ù„ÙØµÙˆÙ„';
  const {order,labels}=getSelectedColumns(); if(!order.length){alert('Ù„Ù… ØªØ®ØªØ± Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');return}
  const thead = `<tr><th>Ø§Ù„Ø±Ù‚Ù…</th>${order.map(k=>`<th>${labels[k]}</th>`).join('')}</tr>`;
  const rows  = data.map((s,i)=>`<tr><td>${i+1}</td>${order.map(k=>`<td>${escapeHtml(s[k]||'')}</td>`).join('')}</tr>`).join('');
  const header = buildOfficialHeaderHTML();
  const html=`<html dir="rtl"><head><title>ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <style> body{font-family:Cairo,sans-serif;margin:20px} h2{margin:8px 0;text-align:center} table{width:100%;border-collapse:collapse;margin-top:12px} th,td{border:1px solid #000;padding:6px;font-size:14px} th{background:#f0f0f0} .header-plain{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px} .header-date{text-align:center;margin:6px 0 10px} </style>
  </head><body>
  ${header}
  <h2>ğŸ“‹ ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
  <p style="text-align:center;margin:4px 0 10px">Ø§Ù„ØµÙ: <b>${grade}</b> â€” Ø§Ù„ÙØµÙ„: <b>${cls}</b><br>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${t.fullDate}</p>
  <table><thead>${thead}</thead><tbody>${rows}</tbody></table>
  </body></html>`;
  const w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close(); w.onload=()=>{w.print(); setTimeout(()=>w.close(),500)}
}
document.getElementById('printBtn').addEventListener('click',printTableOnly);

/* ===== ØªØµØ¯ÙŠØ± Excel Ù…Ø¹ ØªØ±ÙˆÙŠØ³Ø© Ø³Ø§Ø¯Ø© + Ø§Ù„ØªØ§Ø±ÙŠØ® ===== */
function exportFilteredExcel(){
  const data=getFiltered(); if(!data.length){alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.');return}
  const {order,labels}=getSelectedColumns(); if(!order.length){alert('Ù„Ù… ØªØ®ØªØ± Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');return}
  const rows = data.map((s,i)=>{ const obj={'Ø§Ù„Ø±Ù‚Ù…': i+1}; order.forEach(k=>{ obj[labels[k]] = s[k] || ''; }); return obj; });

  const ws = XLSX.utils.json_to_sheet(rows);
  const t=todayInfo();
  const headAoa = [
    [headerData.country||'', "", "", headerData.ministry||""],
    [headerData.directorate||"", "", "", headerData.school||""],
    ["Ø§Ù„ØªØ§Ø±ÙŠØ®:", `${t.hijri} Ø§Ù„Ù…ÙˆØ§ÙÙ‚ ${t.miladi}`, "", ""],
    [""]
  ];
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… index Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆÙ‚ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  XLSX.utils.sheet_add_aoa(ws, headAoa, {origin:"A1"});
  const startRow = headAoa.length + 1;
  const ws2 = XLSX.utils.json_to_sheet(rows, {origin: {r:startRow-1, c:0}});
  Object.assign(ws, ws2);

  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø·Ù„Ø§Ø¨');
  XLSX.writeFile(wb,`ÙƒØ´Ù_Ø§Ù„Ø·Ù„Ø§Ø¨_${t.miladi}.xlsx`);
}
document.getElementById('exportExcelBtn').addEventListener('click',exportFilteredExcel);

/* ===== PDF Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø·Ø§Ù„Ø¨ / Ø§Ù„Ø¬Ù…ÙŠØ¹ (Clean HTML) ===== */
// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ†Ø´Ø¦ Ù…Ø­ØªÙˆÙ‰ HTML Ù†Ø¸ÙŠÙÙ‹Ø§ (Ø¨Ø¯ÙˆÙ† Ø£Ø²Ø±Ø§Ø±) ÙŠØ³ØªØ®Ø¯Ù… ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„
function statsHtmlFor(uid){
  const s=students.find(x=>x.uid===uid);
  const sum=summarize(uid);
  let recs=(loadRecords()[uid]||[]);
  recs.sort((a,b)=>(b.ts||0)-(a.ts||0)); // ÙØ±Ø² Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ PDF
  const header = buildOfficialHeaderHTML();
  const rows = recs.map((r,i)=>{
    const label = r.type==='delay'?'ØªØ£Ø®Ø±':(r.type==='absent'?'ØºÙŠØ§Ø¨':'Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©');
    const m = r.minutes!=null? (r.minutes+' Ø¯Ù‚ÙŠÙ‚Ø©') : 'â€”';
    return `<tr><td>${i+1}</td><td>${label}</td><td>${m}</td><td>${r.date}</td><td>${r.hijri||''}</td><td>${r.time||''}</td></tr>`;
  }).join('') || `<tr><td colspan="6" style="text-align:center;color:#64748b">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`;
  return `
  <div style="page-break-inside:avoid;margin-bottom:18px">
    ${header}
    <h3 style="text-align:center;margin:6px 0">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
    <p style="text-align:center;margin:6px 0">Ø§Ù„Ø§Ø³Ù…: <b>${escapeHtml(s?.name||'')}</b> â€” Ø§Ù„ØµÙ: <b>${escapeHtml(s?.grade||'')}</b> â€” Ø§Ù„ÙØµÙ„: <b>${escapeHtml(s?.class||'')}</b></p>
    <div style="display:flex;gap:8px;justify-content:center;margin:6px 0;flex-wrap:wrap">
      <span class="tag">ØºÙŠØ§Ø¨: <b>${sum.absent}</b></span>
      <span class="tag">ØªØ£Ø®Ø±: <b>${sum.delayCount}</b> Ù…Ø±Ø§Øª (${sum.delayMin} Ø¯Ù‚ÙŠÙ‚Ø©)</span>
      <span class="tag">Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©: <b>${sum.last? (sum.last.date+' - '+sum.last.time) : 'â€”'}</b></span>
    </div>
    <table style="width:100%;border-collapse:collapse;margin-top:8px" border="1" cellspacing="0" cellpadding="6">
      <thead style="background:#f7f7f7"><tr><th>#</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ£Ø®ÙŠØ±</th><th>Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</th><th>Ø§Ù„Ù‡Ø¬Ø±ÙŠ</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}

// ** New Function: Clean printing for single student stats (uses filtered data) **
function printCleanStudentStats(uid, filteredRecs, totalAbsent, totalDelayCount, totalDelayMin) {
    const s=students.find(x=>x.uid===uid);
    const sum=summarize(uid); // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© (ØºÙŠØ± Ù…ÙÙ„ØªØ±Ø©)
    const header = buildOfficialHeaderHTML();
    
    // Rows (clean, no actions) - using the *filtered* records passed from showStats
    const rows = filteredRecs.map((r,i)=>{
        const label = r.type==='delay'?'ØªØ£Ø®Ø±':(r.type==='absent'?'ØºÙŠØ§Ø¨':'Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©');
        const m = r.minutes!=null? (r.minutes+' Ø¯Ù‚ÙŠÙ‚Ø©') : 'â€”';
        return `<tr><td>${i+1}</td><td>${label}</td><td>${m}</td><td>${r.date}</td><td>${r.hijri||''}</td><td>${r.time||''}</td></tr>`;
    }).join('') || `<tr><td colspan="6" style="text-align:center;color:#64748b">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`;

    // Stats HTML for printing 
    const statsHtml = `
    <div style="page-break-inside:avoid;margin-bottom:18px">
      ${header}
      <h3 style="text-align:center;margin:6px 0">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
      <p style="text-align:center;margin:6px 0">Ø§Ù„Ø§Ø³Ù…: <b>${escapeHtml(s?.name||'')}</b> â€” Ø§Ù„ØµÙ: <b>${escapeHtml(s?.grade||'')}</b> â€” Ø§Ù„ÙØµÙ„: <b>${escapeHtml(s?.class||'')}</b></p>
      <div style="display:flex;gap:8px;justify-content:center;margin:6px 0;flex-wrap:wrap">
        <span class="tag">ØºÙŠØ§Ø¨ (Ù…ÙÙÙ„ØªØ±): <b>${totalAbsent}</b></span>
        <span class="tag">ØªØ£Ø®Ø± (Ù…ÙÙÙ„ØªØ±): <b>${totalDelayCount}</b> Ù…Ø±Ø§Øª (${totalDelayMin} Ø¯Ù‚ÙŠÙ‚Ø©)</span>
        <span class="tag">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®Ø± (Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…): <b>${sum.delayCount}</b> Ù…Ø±Ø§Øª (${sum.delayMin} Ø¯Ù‚ÙŠÙ‚Ø©)</span>
      </div>
      <table style="width:100%;border-collapse:collapse;margin-top:8px" border="1" cellspacing="0" cellpadding="6">
        <thead style="background:#f7f7f7"><tr><th>#</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ£Ø®ÙŠØ±</th><th>Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</th><th>Ø§Ù„Ù‡Ø¬Ø±ÙŠ</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

    const html=`<html dir="rtl"><head><meta charset="utf-8"><title>PDF_${uid}</title>
    <style>
        body{font-family:Cairo,sans-serif;margin:20px}
        .tag{background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px; display:inline-block; margin:2px}
        .header-plain{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px} 
        .header-date{text-align:center;margin:6px 0 10px}
        table{width:100%;border-collapse:collapse;margin-top:8px}
        th, td{border:1px solid #000;padding:6px;font-size:14px; text-align:center}
        th{background:#f0f0f0}
    </style>
    </head><body>${statsHtml}</body></html>`;
    const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.onload=()=>{w.print();};
}

function openAllStatsPDF(){ 
  const ids=getFiltered().map(s=>s.uid); if(!ids.length){alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');return} 
  const blocks=ids.map(uid=>statsHtmlFor(uid)).join('<div style="page-break-after:always"></div>'); 
  const html=`<html dir="rtl"><head><meta charset="utf-8"><title>PDF_All</title>
  <style>
    body{font-family:Cairo,sans-serif;margin:20px}
    .tag{background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px; display:inline-block; margin:2px}
    .header-plain{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px} 
    .header-date{text-align:center;margin:6px 0 10px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th, td{border:1px solid #000;padding:6px;font-size:14px; text-align:center}
    th{background:#f0f0f0}
  </style>
  </head><body>${blocks}</body></html>`; 
  const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.onload=()=>{w.print();}; 
}
document.getElementById('exportAllPdfBtn').addEventListener('click', openAllStatsPDF);

/* ===== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª + Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚ ÙŠØ¯ÙˆÙŠ ===== */
if(!document.getElementById('statsModal')){
  const modal=document.createElement('div'); modal.id='statsModal'; modal.className='modal';
  modal.innerHTML=`
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('statsModal').style.display='none'">&times;</span>
    <div id="statsControls" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button class="btn" id="btnAddRecord">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚</button>
      <select id="fltType"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option><option value="delay">ØªØ£Ø®Ø±</option><option value="absent">ØºÙŠØ§Ø¨</option><option value="notice">Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©</option></select>
      <input id="fltYear" type="number" placeholder="Ø³Ù†Ø©" style="width:120px">
      <input id="fltMonth" type="number" placeholder="Ø´Ù‡Ø±" min="1" max="12" style="width:100px">
      <button class="btn" id="fltReset">â™»ï¸ Ù…Ø³Ø­</button>
      <div style="margin-inline-start:auto;display:flex;gap:6px">
        <button class="btn" id="btnPrintStats">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn" id="btnPdfStats">ğŸ“„ PDF</button>
      </div>
    </div>
    <div id="addRecForm" class="card hidden" style="margin:6px 0">
      <div class="grid-fit">
        <select id="ar_type">
          <option value="delay">ØªØ£Ø®Ø±</option>
          <option value="absent">ØºÙŠØ§Ø¨</option>
          <option value="notice">Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©</option>
        </select>
        <input id="ar_date" type="date">
        <input id="ar_time" type="time">
        <input id="ar_minutes" type="number" min="0" placeholder="Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ£Ø®Ø± (Ø¥Ù† ÙˆØ¬Ø¯Øª)">
        <button class="btn" id="ar_save" style="background:var(--ok);color:#fff">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
      </div>
      <div class="small">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª (Ù…Ø§Ø¶Ù) ÙˆØ³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬Ù‡ Ø¶Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©.</div>
    </div>
    <div id="statsDetails">...</div>
  </div>`;
  document.body.appendChild(modal);
}

let currentStatsUid=null;
let editingRecordId=null;

function applyStatsFilter(list){ const y=$('#fltYear').value||''; const m=$('#fltMonth').value||''; const t=$('#fltType').value||''; return list.filter(r=>{ let ok=true; if(y){ ok = ok && r.date?.endsWith(y); } if(m){ 
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø´Ù‡Ø± ÙÙŠ ØµÙŠØºØ© DD / MM / YYYY
    const parts = r.date?.split('/')?.map(p => p.trim());
    ok = ok && (parts?.[1] === String(m).padStart(2, '0'));
  } if(t){ ok = ok && (r.type===t); } return ok; }); }

function showStats(uid){
  currentStatsUid = uid;
  editingRecordId = null;
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
  $('#ar_save').textContent = 'Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„';
  $('#btnAddRecord').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚';
  $('#addRecForm').classList.add('hidden'); 
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  $('#btnAddRecord').onclick=()=>{
    editingRecordId = null;
    $('#ar_save').textContent = 'Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„';
    $('#ar_type').value = 'delay';
    $('#ar_date').value = '';
    $('#ar_time').value = '';
    $('#ar_minutes').value = '';
    $('#addRecForm').classList.toggle('hidden');
  };

  const s = students.find(x=>x.uid===uid); const name=s?.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
  let recs = (loadRecords()[uid] || []);
  // ** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ÙØ±Ø² Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„ÙƒÙŠ ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ **
  recs.sort((a,b)=>(b.ts||0)-(a.ts||0)); 
  const filteredRecs = applyStatsFilter(recs);
  let totalAbsent = filteredRecs.filter(r=>r.type==='absent').length;
  let totalDelayCount = filteredRecs.filter(r=>r.type==='delay').length;
  let totalDelayMin = filteredRecs.filter(r=>r.type==='delay').reduce((a,r)=>a+(r.minutes||0),0);
  
  // ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¹ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù‡Ù†Ø§
  const rows = filteredRecs.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${r.type==='delay'?'ØªØ£Ø®Ø±':(r.type==='absent'?'ØºÙŠØ§Ø¨':'Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©')}</td>
      <td>${r.minutes!=null? (r.minutes+' Ø¯Ù‚ÙŠÙ‚Ø©'): 'â€”'}</td>
      <td>${r.date}</td>
      <td>${r.hijri||''}</td>
      <td>${r.time||''}</td>
      <td>
        <div style="display:flex;gap:4px;justify-content:center">
          <button class="btn btn-sm" style="padding:4px 8px" onclick="editRecord('${r.id}')">âœï¸</button>
          <button class="btn btn-sm" style="padding:4px 8px;background:var(--warn);color:#fff" onclick="deleteRecord('${r.id}')">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`).join('') || `<tr><td colspan="7" style="text-align:center;color:#64748b">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</td></tr>`;
    
  const html = `
    <div class="stats-header">
      <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ${escapeHtml(name)}</h3>
      <div class="tag">ØºÙŠØ§Ø¨: <b>${totalAbsent}</b></div>
      <div class="tag">ØªØ£Ø®Ø±: <b>${totalDelayCount}</b> Ù…Ø±Ø§Øª (${totalDelayMin} Ø¯Ù‚ÙŠÙ‚Ø©)</div>
      <div style="margin:8px 0">
        </div>
    </div>
    <table class="stats-table">
      <thead><tr><th>#</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ£Ø®ÙŠØ±</th><th>Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</th><th>Ø§Ù„Ù‡Ø¬Ø±ÙŠ</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  $('#statsDetails').innerHTML = html;
  $('#statsModal').style.display='flex';
  
  // Ø±Ø¨Ø· Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙÙ„ØªØ±Ø©/Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  $('#fltReset').onclick=()=>{$('#fltType').value='';$('#fltYear').value='';$('#fltMonth').value='';showStats(uid)};
  $('#fltType').onchange=()=>showStats(uid);
  $('#fltYear').oninput=()=>showStats(uid);
  $('#fltMonth').oninput=()=>showStats(uid);
  
  // ** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø¸ÙŠÙØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© **
  $('#btnPrintStats').onclick=()=>printCleanStudentStats(uid, filteredRecs, totalAbsent, totalDelayCount, totalDelayMin);
  $('#btnPdfStats').onclick=()=>printCleanStudentStats(uid, filteredRecs, totalAbsent, totalDelayCount, totalDelayMin);
  
  // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù„Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
  $('#ar_save').onclick=()=>{
    const type=$('#ar_type').value;
    const d=$('#ar_date').value; const t=$('#ar_time').value;
    const mins=Number($('#ar_minutes').value||0);
    if(!d){alert('Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®Ù‹Ø§.');return}
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù‡Ø¬Ø±ÙŠ
    const dt = new Date(`${d}T${t||'07:30'}:00`);
    const dateMiladi = String(dt.getDate()).padStart(2,'0')+' / '+String(dt.getMonth()+1).padStart(2,'0')+' / '+dt.getFullYear();
    const timeOfDay = String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
    
    const hijriTxt = (()=>{try{const p=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'2-digit',month:'2-digit',year:'numeric'}).formatToParts(dt);return `${p.find(x=>x.type==='day')?.value} / ${p.find(x=>x.type==='month')?.value} / ${p.find(x=>x.type==='year')?.value}Ù‡Ù€`}catch{return''}})();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¬Ù„
    const recData={type,minutes:(type==='delay'?Math.max(0,mins):null),date: dateMiladi,hijri:hijriTxt,time: timeOfDay,ts: dt.getTime()};
    
    const all=loadRecords(); 
    if(!all[currentStatsUid]) all[currentStatsUid]=[]; 
    
    if(editingRecordId){
      // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Edit Mode)
      const recIndex = all[currentStatsUid].findIndex(r => r.id === editingRecordId);
      if(recIndex > -1){
        // ** Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ù†ØºÙŠØ± Ø§Ù„Ù€ ID Ù‡Ù†Ø§ **
        all[currentStatsUid][recIndex] = {...all[currentStatsUid][recIndex], ...recData};
      }
      editingRecordId = null; // Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      $('#ar_save').textContent = 'Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„';
    } else {
      // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Add Mode)
      all[currentStatsUid].push({id:Date.now().toString(36)+Math.random().toString(36).slice(2,7), ...recData});
    }
    
    saveRecords(all);
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸/Ø§Ù„ØªØ­Ø¯ÙŠØ«
    $('#addRecForm').classList.add('hidden'); 
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„ÙˆØ¸ÙŠÙØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸/Ø§Ù„ØªØ­Ø¯ÙŠØ«
    $('#btnAddRecord').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚';
    $('#btnAddRecord').onclick=()=>{
        editingRecordId = null;
        $('#ar_save').textContent = 'Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„';
        $('#ar_type').value = 'delay';
        $('#ar_date').value = '';
        $('#ar_time').value = '';
        $('#ar_minutes').value = '';
        $('#addRecForm').classList.toggle('hidden');
    };
    
    showStats(currentStatsUid);
  };
}

/* ===== Ø¯ÙˆØ§Ù„ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± (Ù…ØµØ­Ø­Ø©) ===== */
function deleteRecord(recId){
  if(!currentStatsUid || !recId) return;
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;

  const all=loadRecords();
  if(!all[currentStatsUid]) return;

  // Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù…ØµÙÙˆÙØ© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
  all[currentStatsUid] = all[currentStatsUid].filter(r => r.id !== recId);
  
  // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
  saveRecords(all);
  
  // Ø¥Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙ Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  if(editingRecordId === recId){
    editingRecordId = null;
    $('#addRecForm').classList.add('hidden');
    $('#ar_save').textContent = 'Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„';
  }
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
  showStats(currentStatsUid); 
}

function editRecord(recId){
  if(!currentStatsUid || !recId) return;

  const rec = (loadRecords()[currentStatsUid] || []).find(r => r.id === recId);
  if(!rec) return;

  // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  $('#addRecForm').classList.remove('hidden');

  // ** Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† ØµÙŠØºØ© "DD / MM / YYYY" Ø¥Ù„Ù‰ "YYYY-MM-DD" **
  const dateParts = rec.date.split(' / ').map(p => p.trim());
  const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

  // Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¬Ù„
  $('#ar_type').value = rec.type;
  $('#ar_date').value = formattedDate;
  // ** Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙˆÙ„ 5 Ø£Ø­Ø±Ù (HH:MM) Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (24 Ø³Ø§Ø¹Ø©) **
  $('#ar_time').value = rec.time.slice(0, 5); 
  $('#ar_minutes').value = rec.minutes || 0;
  
  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  editingRecordId = recId;
  $('#ar_save').textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„';
  
  // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  $('#btnAddRecord').textContent = 'âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; 
  $('#btnAddRecord').onclick = () => {
      editingRecordId = null;
      $('#ar_save').textContent = 'Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„';
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„ÙˆØ¸ÙŠÙØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
      $('#btnAddRecord').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚';
      $('#btnAddRecord').onclick=()=>{
        editingRecordId = null;
        $('#ar_save').textContent = 'Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„';
        $('#ar_type').value = 'delay';
        $('#ar_date').value = '';
        $('#ar_time').value = '';
        $('#ar_minutes').value = '';
        $('#addRecForm').classList.toggle('hidden');
      };
      $('#addRecForm').classList.add('hidden');
  };
  window.scrollTo({top:0,behavior:'smooth'}) // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø©
}


/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
function loadSettings(){try{const s=JSON.parse(localStorage.getItem(SETTINGS_KEY)||'{}');settings.hijriAdjust=Number(s.hijriAdjust||0);settings.schoolStart=s.schoolStart||'07:15'}catch{settings={hijriAdjust:0,schoolStart:'07:15'}}}
function saveSettings(){localStorage.setItem(SETTINGS_KEY,JSON.stringify(settings))}
function openSettings(){loadSettings();loadTemplates();loadPE();loadLogo();loadHeaderData();
  $('#schoolStart').value=(settings.schoolStart||'07:15');
  const pp = JSON.parse(localStorage.getItem(PRO_KEY)||'null'); if(pp) pro={...pro,...pp,thr:{...pro.thr,...(pp.thr||{})}};
  $('#opt_showRowSummary').checked=pro.showRowSummary; $('#opt_showLastMsg').checked=pro.showLastMsg; $('#opt_showWarnings').checked=pro.showWarnings; $('#opt_showRowWA').checked=pro.showRowWA; $('#opt_collapseAddForm').checked=pro.collapseAddForm; $('#opt_hideWASection').checked=pro.hideWASection; $('#thr_delay_alert').value=pro.thr.delay_alert; $('#thr_delay_warn').value=pro.thr.delay_warn; $('#thr_absent_alert').value=pro.thr.absent_alert; $('#thr_absent_warn').value=pro.thr.absent_warn;
  $('#settingsPanel').classList.add('open'); $('#settingsOverlay').style.display='block';
}
function closeSettings(){ $('#settingsPanel').classList.remove('open'); $('#settingsOverlay').style.display='none' }
function toggleAcc(id){ document.getElementById(id).classList.toggle('open') }
document.getElementById('saveStartBtn')?.addEventListener('click',()=>{settings.schoolStart=$('#schoolStart').value||'07:15';saveSettings();alert('ØªÙ… Ø­ÙØ¸ ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù….')})
document.getElementById('saveProBtn')?.addEventListener('click',()=>{pro.showRowSummary=$('#opt_showRowSummary').checked;pro.showLastMsg=$('#opt_showLastMsg').checked;pro.showWarnings=$('#opt_showWarnings').checked;pro.showRowWA=$('#opt_showRowWA').checked;pro.collapseAddForm=$('#opt_collapseAddForm').checked;pro.hideWASection=$('#opt_hideWASection').checked;localStorage.setItem(PRO_KEY,JSON.stringify(pro));applyProUI();render();alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.')})
document.getElementById('saveThrBtn')?.addEventListener('click',()=>{pro.thr.delay_alert=Math.max(1,Number($('#thr_delay_alert').value||3));pro.thr.delay_warn=Math.max(1,Number($('#thr_delay_warn').value||5));pro.thr.absent_alert=Math.max(1,Number($('#thr_absent_alert').value||3));pro.thr.absent_warn=Math.max(1,Number($('#thr_absent_warn').value||5));localStorage.setItem(PRO_KEY,JSON.stringify(pro));alert('ØªÙ… Ø­ÙØ¸ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±.')})
document.getElementById('saveTplBtn')?.addEventListener('click',saveTemplates);
document.getElementById('resetTplBtn')?.addEventListener('click',resetTemplates);
document.getElementById('savePEBtn')?.addEventListener('click',savePE);
document.getElementById('resetPEBtn')?.addEventListener('click',resetPE);

function applyProUI(){ $('#addFormCard').classList.toggle('hidden', !!pro.collapseAddForm); $('#waSection').classList.toggle('hidden', !!pro.hideWASection); }
function applyTemplateToBox(){ const sel=$('#templateSelect')?.value; if(!sel||!$('#bulkMsg')) return; if(sel==='custom'){ $('#bulkMsg').value = templates.custom || defaultTemplates().custom; } else if(sel==='delay'){ $('#bulkMsg').value = templates.delay.replaceAll('{name}','{name}'); } else if(sel==='absent'){ $('#bulkMsg').value = templates.absent.replaceAll('{name}','{name}'); } }
document.getElementById('templateSelect').addEventListener('change',applyTemplateToBox);

/* ===== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ===== */
function init(){ loadSettings(); loadLS(); loadTemplates(); loadPE(); loadLogo(); loadHeaderData();
  const pp = JSON.parse(localStorage.getItem(PRO_KEY)||'null'); if(pp) pro={...pro,...pp,thr:{...pro.thr,...(pp.thr||{})}};
  refreshFiltersOptions(); applyProUI(); render(); applyTemplateToBox();
  const statsModal=document.getElementById('statsModal'); if(statsModal) statsModal.style.display='none';
}
init();

</script>
</body>
</html>
